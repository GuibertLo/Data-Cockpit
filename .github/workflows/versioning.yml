name: Adapt versioning

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  update-versions:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Getting parent version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        # Save the modules to GitHub environment
        echo "VERSION=${OLD_VERSION}" >> $GITHUB_ENV

    - name: Determine overall change level
      run: |
        # Initialize highest level priority
        # patch=0, minor=1, major=2
        highest=-1
        
        # Extract Unreleased section
        unreleased=$(awk '/^## Unreleased/{flag=1; next} /^## /{flag=0} flag' "$CHANGELOG")
        
        # Check each line for semantic version tags
        while read -r line; do
            case "$line" in
                major:*) level=2 ;;
                minor:*) level=1 ;;
                patch:*) level=0 ;;
                *) continue ;;
            esac
        
            if (( level > highest )); then
                highest=$level
            fi
        done <<< "$unreleased"
        
        # Map level back to name
        if (( highest == 2 )); then
            CHANGE_TYPE="major"
        elif (( highest == 1 )); then
            CHANGE_TYPE="minor"
        elif (( highest == 0 )); then
            CHANGE_TYPE="patch"
        else
            CHANGE_TYPE=""
        fi

        # Save the modules to GitHub environment
        echo "CHANGE_TYPE=${CHANGE_TYPE}" >> $GITHUB_ENV

    - name: Determine new version number
      run: |
        CHANGE_TYPE="${{ env.CHANGE_TYPE }}"
        OLD_VERSION="${{ env.OLD_VERSION }}"
        
        # Validate inputs
        if [[ -z "$OLD_VERSION" || -z "$CHANGE_TYPE" ]]; then
            echo "Usage: $0 <old_version> <major|minor|patch>"
            exit 1
        fi
        
        if [[ ! "$OLD_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "Old version must be in format X.Y.Z"
            exit 1
        fi
        
        # Extract major, minor, patch
        MAJOR="${BASH_REMATCH[1]}"
        MINOR="${BASH_REMATCH[2]}"
        PATCH="${BASH_REMATCH[3]}"
        
        # Bump version according to semantic versioning
        case "$CHANGE_TYPE" in
            major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
            minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
            patch)
                PATCH=$((PATCH + 1))
                ;;
            *)
                echo "Change type must be one of: major, minor, patch"
                exit 1
                ;;
        esac
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        
        # Save the version number to GitHub environment
        echo "NEW_VERSION=${NEW_VERSION}" >> $GITHUB_ENV

    - name: Update Modules Version
      run: |
        NEW_VERSION="${{ env.NEW_VERSION }}"
        mvn versions:set -DnewVersion={NEW_VERSION} -DprocessAllModules=true -DgenerateBackupPoms=false

    - name: Update Parent Properties
      run: |
        mvn versions:update-properties

    - name: Update Child Modules
      run: |
        mvn -N versions:update-child-modules

    - name: Check PR Description
      id: description-checker
      uses: jadrol/pr-description-checker-action@v1.0.0
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        exempt-labels: no qa

    - name: Configure Git
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "13170944+GuibertLo@users.noreply.github.com"
    - name: Commit & Push
      run: |
        if [[ -n "$(git status --porcelain)" ]]; then
          git add .
          git commit -m "github-actions[bot]: updating software versioning, automation of a post-merge into main"
          git push origin HEAD:develop
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}